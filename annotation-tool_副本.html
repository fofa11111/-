<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¸æˆéšœç¢ç‰©æ ‡æ³¨å·¥å…·</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Arial', sans-serif; 
            background: #1a1a2e; 
            color: white; 
            line-height: 1.6; 
            height: 100vh; 
            overflow: hidden;
        }
        
        .container { 
            display: grid; 
            grid-template-columns: 560px 1fr; 
            grid-template-rows: 1fr auto; 
            height: 100vh;
        }
        
        .left-panel { 
            grid-row: 1 / -1; 
            display: flex; 
            flex-direction: column; 
            background: #16213e; 
            border-right: 2px solid #4361ee; 
            overflow-y: auto;
        }
        
        .training-test-container { display: flex; flex-direction: column; flex: 1; }
        
        .category-section { 
            padding: 20px; 
            background: #16213e; 
            border-bottom: 1px solid #0f3460;
        }
        
        .category-section h2 { 
            margin-bottom: 20px; 
            color: #4361ee; 
            text-align: center;
        }
        
        .category-list { list-style: none; }
        
        .category-item { 
            margin-bottom: 10px; 
            padding: 15px; 
            background: #0f3460; 
            border-radius: 8px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            text-align: center; 
            font-weight: bold;
        }
        
        .category-item:hover { background: #1e5f74; transform: translateX(5px); }
        .category-item.active { background: #e94560; box-shadow: 0 0 15px rgba(233, 69, 96, 0.5); }
        
        .training-section, .testing-section { 
            padding: 20px; 
            background: #1a1a2e; 
            border-top: 1px solid #0f3460; 
            display: flex; 
            flex-direction: column; 
            gap: 15px;
        }
        
        .testing-section { margin-top: auto; }
        
        .training-section h3, .testing-section h3 { 
            color: #4cc9f0; 
            text-align: center; 
            margin-bottom: 10px;
        }
        
        .test-instruction { 
            text-align: center; 
            color: #a9b6d2; 
            font-size: 14px;
        }
        
        .drop-area { 
            border: 3px dashed #4cc9f0; 
            border-radius: 10px; 
            padding: 30px; 
            text-align: center; 
            transition: all 0.3s ease; 
            background: rgba(76, 201, 240, 0.05); 
            min-height: 150px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer;
        }
        
        .drop-area:hover, .drop-area.drag-over { 
            background: rgba(76, 201, 240, 0.1); 
            border-color: #4361ee;
        }
        
        .drop-area-content i { color: #4cc9f0; opacity: 0.7; }
        .drop-area-content p { color: #a9b6d2; margin: 0; }
        
        .recognition-result { 
            background: rgba(34, 197, 94, 0.1); 
            border: 1px solid #22c55e; 
            border-radius: 8px; 
            padding: 15px; 
            margin-top: 15px;
        }
        
        .recognition-result h4 { 
            color: #22c55e; 
            margin-bottom: 10px; 
            text-align: center;
        }
        
        .result-details { 
            display: flex; 
            flex-direction: column; 
            gap: 8px;
        }
        
        .result-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 8px; 
            background: rgba(255, 255, 255, 0.05); 
            border-radius: 5px;
        }
        
        .result-label { font-weight: bold; }
        
        .result-progress { 
            width: 60%; 
            height: 12px; 
            background: rgba(255, 255, 255, 0.1); 
            border-radius: 6px; 
            overflow: hidden; 
            position: relative;
        }
        
        .result-progress-fill { 
            height: 100%; 
            background: linear-gradient(90deg, #22c55e, #16a34a); 
            border-radius: 6px;
        }
        
        .result-percentage { 
            font-weight: bold; 
            min-width: 50px; 
            text-align: right;
        }
        
        .result-image { 
            max-width: 100px; 
            max-height: 100px; 
            margin: 10px auto; 
            display: block; 
            border-radius: 5px; 
            border: 2px solid #4cc9f0;
        }
        
        .progress-section { display: none; width: 100%; }
        
        .progress-bar { 
            width: 100%; 
            height: 25px; 
            background: #0f3460; 
            border-radius: 15px; 
            overflow: hidden; 
            position: relative; 
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .progress-fill { 
            height: 100%; 
            background: linear-gradient(90deg, #4cc9f0, #4361ee); 
            width: 0%; 
            transition: width 0.3s ease; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: bold; 
            font-size: 12px;
        }
        
        .progress-text { 
            text-align: center; 
            margin-top: 8px; 
            color: #4cc9f0; 
            font-size: 14px;
        }
        
        #train-button { 
            padding: 12px 24px; 
            font-size: 16px; 
            font-weight: bold; 
            background: #4cc9f0; 
            color: white; 
            border: none; 
            border-radius: 20px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            box-shadow: 0 4px 15px rgba(76, 201, 240, 0.3); 
            width: 100%;
        }
        
        #train-button:hover { 
            background: #4361ee; 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(67, 97, 238, 0.4);
        }
        
        .success-message { 
            display: none; 
            text-align: center; 
            padding: 15px; 
            background: rgba(34, 197, 94, 0.2); 
            border-radius: 10px; 
            border: 2px solid #22c55e;
        }
        
        .success-message h3 { 
            color: #22c55e; 
            margin-bottom: 8px; 
            font-size: 16px;
        }
        
        .right-panel { 
            display: flex; 
            flex-direction: column; 
            background: #1a1a2e; 
            overflow: hidden;
        }
        
        .header { 
            padding: 20px; 
            text-align: center; 
            background: #16213e; 
            border-bottom: 1px solid #0f3460;
        }
        
        .header h1 { 
            color: #4cc9f0; 
            margin-bottom: 5px;
        }
        
        .header p { 
            color: #a9b6d2; 
            font-size: 14px;
        }
        
        .image-grid { 
            flex: 1; 
            padding: 30px; 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
            column-gap: 25px; 
            row-gap: 30px; 
            overflow-y: auto;
        }
        
        .image-item { 
            position: relative; 
            background: #0f3460; 
            border-radius: 8px; 
            overflow: hidden; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            aspect-ratio: 1; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); 
            min-height: 200px;
        }
        
        .image-item:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
        
        .image-container { 
            flex: 1; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: #1a1a2e; 
            padding: 10px; 
            min-height: 140px;
        }
        
        .image-item img { 
            max-width: 100%; 
            max-height: 100%; 
            object-fit: contain; 
            border-radius: 4px; 
            display: block; 
            min-height: 80px;
        }
        
        .category-badge { 
            padding: 10px 8px; 
            text-align: center; 
            font-weight: bold; 
            font-size: 14px; 
            width: 100%; 
            box-sizing: border-box; 
            min-height: 40px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
        }
        
        .category-badge.unlabeled { background: #6c757d; opacity: 1; }
        .category-badge.rock { background: #ff9f1c; color: black; }
        .category-badge.barrier { background: #e71d36; }
        .category-badge.dog { background: #22c55e; color: black; }
        .category-badge.plastic-bag { background: #8338ec; color: white; }
        .category-badge.grandma { background: #fb8500; color: white; }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        .image-grid::-webkit-scrollbar { width: 8px; }
        .image-grid::-webkit-scrollbar-track { background: #0f3460; border-radius: 4px; }
        .image-grid::-webkit-scrollbar-thumb { background: #4361ee; border-radius: 4px; }
        .image-grid::-webkit-scrollbar-thumb:hover { background: #4cc9f0; }
        
        /* æ—¥å¿—åŒºåŸŸæ ·å¼ */
        .logs-section {
            margin-top: 20px;
            padding: 20px;
            background: #0f3460;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        
        .logs-section h4 {
            color: #4cc9f0;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .log-item {
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            border-left: 3px solid #4cc9f0;
        }
        
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-weight: bold;
            color: #4cc9f0;
        }
        
        .log-time {
            font-size: 12px;
            color: #a9b6d2;
        }
        
        .log-content {
            font-size: 14px;
            line-height: 1.5;
        }
        
        .log-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 12px;
        }
        
        .log-table th,
        .log-table td {
            padding: 6px 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .log-table th {
            background: rgba(255, 255, 255, 0.1);
            color: #4cc9f0;
        }
        
        .logs-section::-webkit-scrollbar { width: 6px; }
        .logs-section::-webkit-scrollbar-track { background: #16213e; border-radius: 3px; }
        .logs-section::-webkit-scrollbar-thumb { background: #4361ee; border-radius: 3px; }
        .logs-section::-webkit-scrollbar-thumb:hover { background: #4cc9f0; }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§é¢æ¿ -->
        <div class="left-panel">
            <!-- å·¦ä¸Šè§’ï¼šç±»åˆ«é€‰æ‹© -->
            <div class="category-section">
                <h2>éšœç¢ç‰©ç±»åˆ«</h2>
                <ul class="category-list">
                    <li class="category-item" data-category="rock">çŸ³å¤´</li>
                    <li class="category-item" data-category="barrier">è·¯éšœ</li>
                    <li class="category-item" data-category="dog">ç‹—</li>
                    <li class="category-item" data-category="grandma">è€å¥¶å¥¶</li>
                    <li class="category-item" data-category="unlabeled">æ¸…é™¤æ ‡æ³¨</li>
                </ul>
            </div>
            
            <div class="training-test-container">
                <!-- è®­ç»ƒæ§åˆ¶ -->
                <div class="training-section">
                    <h3>æœºå™¨å­¦ä¹ è®­ç»ƒ</h3>
                    
                    <div class="progress-section" id="progress-section">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill">0%</div>
                        </div>
                        <div class="progress-text" id="progress-text">å‡†å¤‡è®­ç»ƒ...</div>
                    </div>
                    
                    <div class="success-message" id="success-message">
                        <h3>ğŸ‰ è®­ç»ƒæˆåŠŸï¼</h3>
                        <p>æ‚¨çš„éšœç¢ç‰©è¯†åˆ«æ¨¡å‹å·²æˆåŠŸè®­ç»ƒå®Œæˆï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•äº†ã€‚</p>
                    </div>
                    
                    <button id="train-button">å¼€å§‹æœºå™¨å­¦ä¹ </button>
                </div>
                
                <!-- æµ‹è¯•åŠŸèƒ½å— -->
                <div class="testing-section" id="testing-section">
                    <h3>æµ‹è¯•æœºå™¨å­¦ä¹ ç»“æœ</h3>
                    <p class="test-instruction">å°†å³ä¾§å›¾ç‰‡æ‹–æ”¾åˆ°ä¸‹æ–¹åŒºåŸŸè¿›è¡Œæµ‹è¯•ï¼š</p>
                    <div id="drop-area" class="drop-area">
                        <div class="drop-area-content">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 48px; margin-bottom: 10px;"></i>
                            <p>æ‹–æ”¾å›¾ç‰‡åˆ°æ­¤å¤„</p>
                        </div>
                    </div>
                    <div id="recognition-result" class="recognition-result" style="display: none;">
                        <h4>è¯†åˆ«ç»“æœ</h4>
                        <div id="result-details"></div>
                    </div>
                    
                    <!-- æ—¥å¿—åŒºåŸŸ -->
                    <div class="logs-section" id="logs-section">
                        <h4>è®­ç»ƒä¸æµ‹è¯•æ—¥å¿—</h4>
                        <div id="logs-container"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å³ä¾§ï¼šå›¾ç‰‡åŒºåŸŸ -->
        <div class="right-panel">
            <div class="header">
                <h1>æ¸¸æˆéšœç¢ç‰©æ ‡æ³¨å·¥å…·</h1>
                <p>é€‰æ‹©å·¦ä¾§ç±»åˆ«ï¼Œç„¶åç‚¹å‡»å³ä¾§å›¾ç‰‡è¿›è¡Œæ ‡æ³¨</p>
            </div>
            
            <div class="image-grid" id="image-grid">
                <!-- å›¾ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // é€‰æ‹©å™¨
            const categoryItems = document.querySelectorAll('.category-item');
            const imageGrid = document.getElementById('image-grid');
            const trainButton = document.getElementById('train-button');
            const progressSection = document.getElementById('progress-section');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            const successMessage = document.getElementById('success-message');
            const testingSection = document.getElementById('testing-section');
            const dropArea = document.getElementById('drop-area');
            const recognitionResult = document.getElementById('recognition-result');
            const resultDetails = document.getElementById('result-details');
            const logsSection = document.getElementById('logs-section');
            const logsContainer = document.getElementById('logs-container');
            
            // åˆå§‹éšè—æµ‹è¯•åŠŸèƒ½å—
            testingSection.style.display = 'none';
            
            // æ·»åŠ CSSæ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                #retrain-button {
                    background: #f97316;
                    border: none;
                    color: white;
                    padding: 12px 24px;
                    text-align: center;
                    text-decoration: none;
                    display: inline-block;
                    font-size: 16px;
                    margin: 4px 2px;
                    cursor: pointer;
                    border-radius: 6px;
                    transition: background 0.3s;
                }
                
                #retrain-button:hover {
                    background: #ea580c;
                }
            `;
            document.head.appendChild(style);
            
            // å½“å‰é€‰ä¸­çš„ç±»åˆ«
            let selectedCategory = null;
            
            // ç±»åˆ«åç§°æ˜ å°„
            const categoryNames = {
                'rock': 'çŸ³å¤´',
                'barrier': 'è·¯éšœ',
                'dog': 'ç‹—',
                'grandma': 'è€å¥¶å¥¶',
                'plastic-bag': 'å¡‘æ–™è¢‹',
                'unlabeled': 'æœªæ ‡æ³¨'
            };
            
            // åˆå§‹åŒ–å›¾ç‰‡æ•°ç»„
            const images = [
                {id: 1, src: 'images/çŸ³å¤´1.png', category: null},
                {id: 2, src: 'images/çŸ³å¤´2.png', category: null},
                {id: 3, src: 'images/çŸ³å¤´3.png', category: null},
                {id: 4, src: 'images/çŸ³å¤´6.png', category: null},
                {id: 5, src: 'images/çŸ³å¤´7.png', category: null},
                {id: 6, src: 'images/çŸ³å¤´8.png', category: null},
                {id: 7, src: 'images/çŸ³å¤´9.png', category: null},
                {id: 8, src: 'images/çŸ³å¤´10.png', category: null},
                {id: 9, src: 'images/çŸ³å¤´11.png', category: null},
                {id: 10, src: 'images/è·¯éšœ 1.png', category: null},
                {id: 11, src: 'images/è·¯éšœ2.png', category: null},
                {id: 12, src: 'images/è·¯éšœ3.png', category: null},
                {id: 13, src: 'images/è·¯éšœ4.png', category: null},
                {id: 14, src: 'images/è·¯éšœ5.png', category: null},
                {id: 15, src: 'images/è·¯éšœ6.png', category: null},
                {id: 16, src: 'images/è·¯éšœ7.png', category: null},
                {id: 17, src: 'images/è·¯éšœ8.png', category: null},
                {id: 18, src: 'images/è·¯éšœ9.png', category: null},
                {id: 19, src: 'images/è·¯éšœ10.png', category: null},
                {id: 20, src: 'images/ç‹—1.png', category: null},
                {id: 21, src: 'images/è€å¥¶å¥¶1.png', category: null},
                {id: 22, src: 'images/å¡‘æ–™è¢‹.png', category: null}
            ];
            
            // æµ‹è¯•å›¾ç‰‡æ•°ç»„ - çŸ³å¤´11-18ã€è€å¥¶å¥¶11-13ã€è·¯éšœ11-13å…±15å¼ å›¾ç‰‡
            const testImages = [
                {id: 101, src: 'images/çŸ³å¤´11.png', category: null},
                {id: 102, src: 'images/çŸ³å¤´12.png', category: null},
                {id: 103, src: 'images/çŸ³å¤´13.png', category: null},
                {id: 104, src: 'images/çŸ³å¤´14.png', category: null},
                {id: 105, src: 'images/çŸ³å¤´15.png', category: null},
                {id: 106, src: 'images/çŸ³å¤´16.png', category: null},
                {id: 107, src: 'images/çŸ³å¤´17.png', category: null},
                {id: 108, src: 'images/çŸ³å¤´18.png', category: null},
                {id: 109, src: 'images/è€å¥¶å¥¶11.png', category: null},
                {id: 110, src: 'images/è€å¥¶å¥¶12.png', category: null},
                {id: 111, src: 'images/è€å¥¶å¥¶13.png', category: null},
                {id: 112, src: 'images/è·¯éšœ11.png', category: null},
                {id: 113, src: 'images/è·¯éšœ12.png', category: null},
                {id: 114, src: 'images/è·¯éšœ13.png', category: null}
            ];
            
            // åˆå§‹åŒ–ç©ºçš„è®­ç»ƒæ•°æ®å¯¹è±¡
            let trainingData = {
                'rock': { 'rock': 0, 'barrier': 0, 'dog': 0, 'grandma': 0, 'plastic-bag': 0 },
                'barrier': { 'rock': 0, 'barrier': 0, 'dog': 0, 'grandma': 0, 'plastic-bag': 0 },
                'dog': { 'rock': 0, 'barrier': 0, 'dog': 0, 'grandma': 0, 'plastic-bag': 0 },
                'grandma': { 'rock': 0, 'barrier': 0, 'dog': 0, 'grandma': 0, 'plastic-bag': 0 },
                'plastic-bag': { 'rock': 0, 'barrier': 0, 'dog': 0, 'grandma': 0, 'plastic-bag': 0 }
            };
            
            // ä¸ºç±»åˆ«é€‰æ‹©å™¨æ·»åŠ ç‚¹å‡»äº‹ä»¶
            categoryItems.forEach(item => {
                item.addEventListener('click', function() {
                    // ç§»é™¤æ‰€æœ‰ç±»åˆ«çš„é€‰ä¸­çŠ¶æ€
                    categoryItems.forEach(cat => cat.classList.remove('active'));
                    
                    // ä¸ºå½“å‰ç‚¹å‡»çš„ç±»åˆ«æ·»åŠ é€‰ä¸­çŠ¶æ€
                    this.classList.add('active');
                    
                    // æ›´æ–°å½“å‰é€‰ä¸­çš„ç±»åˆ«
                    selectedCategory = this.dataset.category;
                });
            });
            
            // åˆ‡æ¢åˆ°æµ‹è¯•å›¾ç‰‡æ± 
            function switchToTestImages() {
                // æ¸…ç©ºå›¾ç‰‡ç½‘æ ¼
                imageGrid.innerHTML = '';
                
                // æ›´æ–°å³ä¾§é¢æ¿æ ‡é¢˜
                document.querySelector('.right-panel .header h1').textContent = 'æ¨¡å‹æµ‹è¯•';
                document.querySelector('.right-panel .header p').textContent = 'å°†å›¾ç‰‡æ‹–æ”¾åˆ°å·¦ä¾§åŒºåŸŸè¿›è¡Œæµ‹è¯•';
                
                // æ¸²æŸ“æµ‹è¯•å›¾ç‰‡
                testImages.forEach(image => {
                    const imageItem = document.createElement('div');
                    imageItem.className = 'image-item';
                    imageItem.dataset.id = image.id;
                    
                    // åˆå§‹åŒ–æ—¶æ·»åŠ ç±»åˆ«å¾½ç« ï¼Œé»˜è®¤ä¸ºæœªæ ‡æ³¨
                    const initialCategory = image.category || 'unlabeled';
                    const categoryClass = `category-badge ${initialCategory}`;
                    const categoryText = categoryNames[initialCategory] || 'æœªæ ‡æ³¨';
                    
                    imageItem.innerHTML = `
                        <div class="image-container">
                            <img src="${image.src}" alt="${image.src}">
                        </div>
                        <div class="${categoryClass}">${categoryText}</div>
                    `;
                    
                    imageGrid.appendChild(imageItem);
                    
                    // æ·»åŠ æ‹–æ‹½åŠŸèƒ½
                    imageItem.setAttribute('draggable', 'true');
                    
                    imageItem.addEventListener('dragstart', function(e) {
                        e.dataTransfer.setData('text/plain', JSON.stringify(image));
                        this.classList.add('dragging');
                    });
                    
                    imageItem.addEventListener('dragend', function() {
                        this.classList.remove('dragging');
                    });
                });
            }
            
            // ä¸ºè®­ç»ƒæŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
            trainButton.addEventListener('click', function() {
                // æ˜¾ç¤ºè¿›åº¦æ¡
                progressSection.style.display = 'block';
                progressFill.style.width = '0%';
                progressText.textContent = '0%';
                
                // æ¨¡æ‹Ÿè®­ç»ƒè¿‡ç¨‹
                let progress = 0;
                const interval = setInterval(() => {
                    progress += 5;
                    progressFill.style.width = `${progress}%`;
                    progressText.textContent = `${progress}%`;
                    
                    if (progress >= 100) {
                        clearInterval(interval);
                        
                        // ç›´æ¥æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        successMessage.style.display = 'block';
                        
                        // è®°å½•è®­ç»ƒæ•°æ®æ—¥å¿—
                        logTrainingData();
                        
                        // æ˜¾ç¤ºæ—¥å¿—åŒºåŸŸ
                        logsSection.style.display = 'block';
                        
                        // éšè—ç±»åˆ«é€‰æ‹©
                        document.querySelector('.category-section').style.display = 'none';
                        
                        // ä¿ç•™è®­ç»ƒåŒºåŸŸï¼ˆåŒ…å«æˆåŠŸæ¶ˆæ¯å’Œè¿›åº¦æ¡ï¼‰ï¼Œåªéšè—è®­ç»ƒæ§åˆ¶æŒ‰é’®
                        document.querySelector('#train-button').style.display = 'none';
                        
                        // æ·»åŠ ä¸‹ä¸€æ­¥æŒ‰é’®åˆ°æˆåŠŸæ¶ˆæ¯ä¸‹æ–¹
                        const nextStepButton = document.createElement('button');
                        nextStepButton.id = 'next-step-button';
                        nextStepButton.textContent = 'ä¸‹ä¸€æ­¥';
                        nextStepButton.style.marginTop = '10px';
                        nextStepButton.style.padding = '10px 20px';
                        nextStepButton.style.fontSize = '16px';
                        nextStepButton.style.backgroundColor = '#4CAF50';
                        nextStepButton.style.color = 'white';
                        nextStepButton.style.border = 'none';
                        nextStepButton.style.borderRadius = '4px';
                        nextStepButton.style.cursor = 'pointer';
                        
                        // æ·»åŠ ç‚¹å‡»äº‹ä»¶è·³è½¬åˆ°æ±½è½¦æ¸¸æˆé¡µé¢
                        nextStepButton.addEventListener('click', function() {
                            window.location.href = 'car-simulation.html';
                        });
                        
                        // å°†æŒ‰é’®æ·»åŠ åˆ°æˆåŠŸæ¶ˆæ¯ä¸‹æ–¹
                        successMessage.appendChild(nextStepButton);
                        
                        // æ˜¾ç¤ºæµ‹è¯•åŠŸèƒ½å—
                        testingSection.style.display = 'block';
                        
                        // åˆ›å»ºæ–°çš„é‡æ–°å­¦ä¹ æŒ‰é’®å¹¶æ·»åŠ åˆ°æµ‹è¯•åŒºåŸŸé¡¶éƒ¨
                        const retrainButton = document.createElement('button');
                        retrainButton.id = 'retrain-button';
                        retrainButton.textContent = 'é‡æ–°å­¦ä¹ ';
                        retrainButton.style.marginTop = '10px';
                        retrainButton.addEventListener('click', function() {
                            // åˆ·æ–°é¡µé¢å›åˆ°è®­ç»ƒæ¨¡å¼
                            location.reload();
                        });
                        testingSection.prepend(retrainButton);
                        
                        // åˆ‡æ¢åˆ°æµ‹è¯•å›¾ç‰‡æ± 
                        switchToTestImages();
                    }
                }, 100);
            });
            
            // æ¸²æŸ“åˆå§‹å›¾ç‰‡åˆ°é¡µé¢ä¸Š
            images.forEach(image => {
                const imageItem = document.createElement('div');
                imageItem.className = 'image-item';
                imageItem.dataset.id = image.id;
                
                // åˆå§‹åŒ–æ—¶æ·»åŠ ç±»åˆ«å¾½ç« ï¼Œé»˜è®¤ä¸ºæœªæ ‡æ³¨
                const initialCategory = image.category || 'unlabeled';
                const categoryClass = `category-badge ${initialCategory}`;
                const categoryText = categoryNames[initialCategory] || 'æœªæ ‡æ³¨';
                
                imageItem.innerHTML = `
                    <div class="image-container">
                        <img src="${image.src}" alt="${image.src}">
                    </div>
                    <div class="${categoryClass}">${categoryText}</div>
                `;
                
                imageGrid.appendChild(imageItem);
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç”¨äºæ ‡æ³¨
                imageItem.addEventListener('click', function() {
                    if (selectedCategory) {
                        // è·å–ç±»åˆ«å¾½ç« å…ƒç´ 
                        const categoryBadge = this.querySelector('.category-badge');
                        
                        if (selectedCategory === 'unlabeled') {
                            // æ¸…é™¤æ ‡æ³¨
                            this.classList.remove('annotated');
                            this.removeAttribute('data-category');
                            image.category = null;
                            
                            // æ›´æ–°ç±»åˆ«å¾½ç« 
                            if (categoryBadge) {
                                categoryBadge.className = 'category-badge unlabeled';
                                categoryBadge.textContent = 'æœªæ ‡æ³¨';
                            }
                        } else {
                            // æ·»åŠ æ ‡æ³¨
                            this.classList.add('annotated');
                            this.dataset.category = selectedCategory;
                            image.category = selectedCategory;
                            
                            // æ›´æ–°ç±»åˆ«å¾½ç« 
                            if (categoryBadge) {
                                categoryBadge.className = `category-badge ${selectedCategory}`;
                                categoryBadge.textContent = categoryNames[selectedCategory] || selectedCategory;
                            }
                            
                            // æ›´æ–°è®­ç»ƒæ•°æ® - å½“æ ‡æ³¨å›¾ç‰‡æ—¶ï¼Œä½¿ç”¨è¯¥å›¾ç‰‡çš„æ–‡ä»¶åæ¥åˆ¤æ–­å®é™…ç±»å‹
                            // ä»å›¾ç‰‡srcä¸­æå–å®é™…ç±»å‹
                            let actualType = 'unlabeled';
                            const src = image.src.toLowerCase();
                            if (src.includes('çŸ³å¤´')) actualType = 'rock';
                            else if (src.includes('è·¯éšœ')) actualType = 'barrier';
                            else if (src.includes('ç‹—')) actualType = 'dog';
                            else if (src.includes('è€å¥¶å¥¶')) actualType = 'grandma';
                            else if (src.includes('å¡‘æ–™è¢‹')) actualType = 'plastic-bag';
                            
                            // åªåœ¨å®é™…ç±»å‹ä¸æ ‡æ³¨ç±»åˆ«ä¸åŒæ—¶æ›´æ–°æ··æ·†çŸ©é˜µ
                            if (actualType !== 'unlabeled') {
                                updateTrainingData(selectedCategory, actualType);
                            }
                        }
                    }
                });
                
                // æ·»åŠ æ‹–æ‹½åŠŸèƒ½
                imageItem.setAttribute('draggable', 'true');
                
                imageItem.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', JSON.stringify(image));
                    this.classList.add('dragging');
                });
                
                imageItem.addEventListener('dragend', function() {
                    this.classList.remove('dragging');
                });
            });
            
            // æ›´æ–°è®­ç»ƒæ•°æ®
            function updateTrainingData(actualCategory, actualType) {
                // ç¡®ä¿ç±»åˆ«å­˜åœ¨
                if (!trainingData[actualCategory]) {
                    trainingData[actualCategory] = {};
                }
                
                // åˆå§‹åŒ–æˆ–å¢åŠ è®¡æ•°
                if (trainingData[actualCategory][actualType] === undefined) {
                    trainingData[actualCategory][actualType] = 1;
                } else {
                    trainingData[actualCategory][actualType]++;
                }
            }
            
            // è®¡ç®—å•ä¸ªç±»åˆ«çš„æ¦‚ç‡
            function calculateCategoryProbability(category, matchingImagesCount, totalImagesCount) {
                // é»˜è®¤å€¼å¤„ç†
                matchingImagesCount = matchingImagesCount || 0;
                totalImagesCount = totalImagesCount || 0;
                
                // å¦‚æœè¯¥ç±»åˆ«æ²¡æœ‰è®­ç»ƒæ•°æ®ï¼Œæ¦‚ç‡è¾ƒä½ä½†ä¸ä¸º0
                if (totalImagesCount === 0) {
                    return 4 + Math.random() * 4; // 4-8%çš„åŸºç¡€æ¦‚ç‡
                }
                
                // è®¡ç®—åŒ¹é…ç‡
                const matchRate = matchingImagesCount / totalImagesCount;
                
                // æ ¹æ®åŒ¹é…å›¾åƒæ•°é‡è®¡ç®—åŸºç¡€æ¦‚ç‡
                let baseProbability, range;
                
                if (matchingImagesCount <= 0) {
                    baseProbability = 5;
                    range = 3;
                } else if (matchingImagesCount === 1) {
                    baseProbability = Math.max(0, 15 * matchRate);
                    range = 6;
                } else if (matchingImagesCount === 2) {
                    baseProbability = Math.max(0, 30 * matchRate);
                    range = 5;
                } else if (matchingImagesCount === 3) {
                    baseProbability = Math.max(0, 40 * matchRate);
                    range = 4;
                } else if (matchingImagesCount === 4) {
                    baseProbability = Math.max(0, 50 * matchRate);
                    range = 4;
                } else if (matchingImagesCount === 5) {
                    baseProbability = Math.max(0, 60 * matchRate);
                    range = 3;
                } else if (matchingImagesCount === 6) {
                    baseProbability = Math.max(0, 70 * matchRate);
                    range = 3;
                } else if (matchingImagesCount === 7) {
                    baseProbability = Math.max(0, 80 * matchRate);
                    range = 2;
                } else if (matchingImagesCount === 8) {
                    baseProbability = Math.max(0, 90 * matchRate);
                    range = 2;
                } else {
                    // 9å¼ åŠä»¥ä¸Š - æé«˜æƒé‡ï¼Œè®©å¤§é‡è®­ç»ƒæ•°æ®çš„ç±»åˆ«è·å¾—æ›´é«˜æ¦‚ç‡
                    baseProbability = Math.max(0, Math.min(99 * matchRate, 99));
                    range = 1; // å‡å°‘éšæœºæ€§ï¼Œå¢åŠ ç¡®å®šæ€§
                }
                
                // æ·»åŠ éšæœºæ€§
                const randomOffset = (Math.random() - 0.5) * 2 * range;
                let probability = baseProbability + randomOffset;
                
                // ç¡®ä¿æ¦‚ç‡åœ¨åˆç†èŒƒå›´å†…
                probability = Math.max(0.5, Math.min(99.5, probability));
                
                return probability;
            }
            
            // è®¡ç®—å„ç±»åˆ«çš„æ¦‚ç‡ï¼ˆä¼˜åŒ–ç‰ˆ - æ•´åˆæ¦‚ç‡è®¡ç®—é€»è¾‘ï¼Œæ”¹è¿›å½’ä¸€åŒ–å¤„ç†ï¼‰
            function calculateProbabilities(actualType) {
                const categories = ['rock', 'barrier', 'dog', 'grandma', 'plastic-bag'];
                const results = [];
                
                // æ‰¾å‡ºæœ‰æœ€å¤šè®­ç»ƒæ•°æ®çš„ç±»åˆ«ä½œä¸ºåŸºå‡†
                let maxTrainingData = 0;
                let hasSignificantTrainingData = false;
                
                // å¯¹æ¯ä¸ªç±»åˆ«è®¡ç®—åˆå§‹æ¦‚ç‡
                for (const category of categories) {
                    // è·å–è¯¥ç±»åˆ«çš„è®­ç»ƒæ•°æ®
                    const categoryData = trainingData[category];
                    
                    // è®¡ç®—ç±»åˆ«æ€»å›¾ç‰‡æ•°
                    let totalImagesCount = 0;
                    for (const type in categoryData) {
                        totalImagesCount += categoryData[type] || 0;
                    }
                    
                    // æ›´æ–°æœ€å¤§è®­ç»ƒæ•°æ®é‡
                    if (totalImagesCount > maxTrainingData) {
                        maxTrainingData = totalImagesCount;
                    }
                    
                    // åˆ¤æ–­æ˜¯å¦æœ‰è¶³å¤Ÿçš„è®­ç»ƒæ•°æ®
                    if (totalImagesCount >= 5) {
                        hasSignificantTrainingData = true;
                    }
                    
                    // è®¡ç®—åŒ¹é…å›¾ç‰‡æ•°
                    const matchingImagesCount = categoryData[actualType] || 0;
                    
                    // è°ƒç”¨ä¼˜åŒ–åçš„å•ä¸ªç±»åˆ«æ¦‚ç‡è®¡ç®—å‡½æ•°
                    const probability = calculateCategoryProbability(category, matchingImagesCount, totalImagesCount);
                    
                    results.push({
                        category: category,
                        name: categoryNames[category],
                        probability: probability,
                        totalImagesCount: totalImagesCount // ä¿å­˜ç”¨äºåç»­æƒé‡è®¡ç®—
                    });
                }
                
                // æ­¥éª¤5ï¼šæ”¹è¿›çš„æ¦‚ç‡å½’ä¸€åŒ–å¤„ç†
                // å½“æœ‰æ˜¾è‘—è®­ç»ƒæ•°æ®æ—¶ï¼Œä½¿ç”¨åŠ æƒå½’ä¸€åŒ–ï¼Œè®©è®­ç»ƒæ•°æ®å¤šçš„ç±»åˆ«è·å¾—æ›´é«˜æƒé‡
                if (hasSignificantTrainingData && maxTrainingData > 0) {
                    let weightedTotal = 0;
                    
                    // è®¡ç®—åŠ æƒæ€»å’Œ
                    for (const result of results) {
                        // ä¸ºè®­ç»ƒæ•°æ®å¤šçš„ç±»åˆ«å¢åŠ æ›´æ˜æ˜¾çš„æƒé‡
                        const confidenceWeight = 1 + 1.5 * (result.totalImagesCount / maxTrainingData);
                        result.weightedProbability = result.probability * confidenceWeight;
                        weightedTotal += result.weightedProbability;
                    }
                    
                    // åº”ç”¨åŠ æƒå½’ä¸€åŒ–
                    const adjustmentFactor = 100 / weightedTotal;
                    for (const result of results) {
                        result.probability = result.weightedProbability * adjustmentFactor;
                        // é‡Šæ”¾ä¸´æ—¶å±æ€§
                        delete result.weightedProbability;
                    }
                } else {
                    // ä¼ ç»Ÿå½’ä¸€åŒ–ï¼ˆå½“è®­ç»ƒæ•°æ®è¾ƒå°‘æ—¶ï¼‰
                    let totalProbability = 0;
                    for (const result of results) {
                        totalProbability += result.probability;
                    }
                    
                    if (totalProbability === 0) {
                        // å¦‚æœæ€»å’Œä¸º0ï¼Œå¹³å‡åˆ†é…
                        const equalProbability = 100 / categories.length;
                        for (const result of results) {
                            result.probability = equalProbability;
                        }
                    } else {
                        // åº”ç”¨è°ƒæ•´å› å­ç¡®ä¿æ€»å’Œä¸º100%
                        const adjustmentFactor = 100 / totalProbability;
                        for (const result of results) {
                            result.probability = result.probability * adjustmentFactor;
                        }
                    }
                }
                
                // å››èˆäº”å…¥å¹¶ç¡®ä¿æ¦‚ç‡åœ¨åˆç†èŒƒå›´å†…
                for (const result of results) {
                    result.probability = Math.round(result.probability);
                    result.probability = Math.max(0.5, Math.min(99.5, result.probability));
                    // é‡Šæ”¾ä¸´æ—¶å±æ€§
                    delete result.totalImagesCount;
                }
                
                // æŒ‰æ¦‚ç‡æ’åº
                results.sort((a, b) => b.probability - a.probability);
                
                return results;
            }
            
            // å¤„ç†å›¾ç‰‡æ‹–æ”¾æµ‹è¯•
            function handleDrop(e) {
                e.preventDefault();
                dropArea.classList.remove('drag-over');
                
                try {
                    // å°è¯•è·å–æ‹–æ‹½çš„æ•°æ®
                    const imageDataJson = e.dataTransfer.getData('text/plain');
                    const imageData = JSON.parse(imageDataJson);
                    
                    // ä»å›¾ç‰‡srcä¸­æå–å®é™…ç±»å‹ï¼ˆä¸æ ‡æ³¨æ—¶ä½¿ç”¨ç›¸åŒçš„é€»è¾‘ï¼‰
                    let actualType = 'unlabeled';
                    const src = imageData.src.toLowerCase();
                    if (src.includes('çŸ³å¤´')) actualType = 'rock';
                    else if (src.includes('è·¯éšœ')) actualType = 'barrier';
                    else if (src.includes('ç‹—')) actualType = 'dog';
                    else if (src.includes('è€å¥¶å¥¶')) actualType = 'grandma';
                    else if (src.includes('å¡‘æ–™è¢‹')) actualType = 'plastic-bag';
                    
                    // å¦‚æœæ— æ³•ä»æ–‡ä»¶åç¡®å®šç±»å‹ï¼Œä½¿ç”¨éšæœºç±»å‹
                    if (actualType === 'unlabeled') {
                        actualType = ['rock', 'barrier', 'dog', 'grandma', 'plastic-bag'][Math.floor(Math.random() * 5)];
                    }
                    
                    // è®¡ç®—æ¦‚ç‡
                    const results = calculateProbabilities(actualType);
                    
                    // æ˜¾ç¤ºç»“æœ
                    displayRecognitionResults(results, imageData.src);
                } catch (error) {
                    console.error('å¤„ç†æ‹–æ”¾å¤±è´¥:', error);
                }
            }
            
            // æ˜¾ç¤ºè¯†åˆ«ç»“æœ
            function displayRecognitionResults(results, imageSrc) {
                // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
                resultDetails.innerHTML = '';
                
                // æ·»åŠ ç»“æœé¡¹
                results.forEach(result => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'result-item';
                    
                    resultItem.innerHTML = `
                        <span class="result-label">${result.name}</span>
                        <div class="result-progress">
                            <div class="result-progress-fill" style="width: ${result.probability}%"></div>
                        </div>
                        <span class="result-percentage">${result.probability}%</span>
                    `;
                    
                    resultDetails.appendChild(resultItem);
                });
                
                // å¦‚æœæœ‰å›¾ç‰‡æºï¼Œæ·»åŠ å›¾ç‰‡é¢„è§ˆ
                if (imageSrc) {
                    const imgElement = document.createElement('img');
                    imgElement.src = imageSrc;
                    imgElement.className = 'result-image';
                    resultDetails.insertBefore(imgElement, resultDetails.firstChild);
                }
                
                // æ˜¾ç¤ºç»“æœåŒºåŸŸ
                recognitionResult.style.display = 'block';
                
                // è®°å½•æµ‹è¯•ç»“æœæ—¥å¿—
                logTestResults(results, imageSrc);
            }
            
            // è®°å½•è®­ç»ƒæ•°æ®åˆ°æ—¥å¿—
            function logTrainingData() {
                const now = new Date();
                const timestamp = now.toLocaleString();
                
                // åˆ›å»ºæ—¥å¿—é¡¹
                const logItem = document.createElement('div');
                logItem.className = 'log-item';
                
                // æ„å»ºè®­ç»ƒæ•°æ®è¡¨æ ¼
                let tableHtml = `
                    <table class="log-table">
                        <thead>
                            <tr>
                                <th>ç±»åˆ«</th>
                                <th>çŸ³å¤´</th>
                                <th>è·¯éšœ</th>
                                <th>ç‹—</th>
                                <th>è€å¥¶å¥¶</th>
                                <th>å¡‘æ–™è¢‹</th>
                            </tr>
                        </thead>
                        <tbody>`;
                
                // æ·»åŠ æ¯è¡Œæ•°æ®
                for (const [category, data] of Object.entries(trainingData)) {
                    tableHtml += `
                        <tr>
                            <td>${categoryNames[category]}</td>
                            <td>${data['rock'] || 0}</td>
                            <td>${data['barrier'] || 0}</td>
                            <td>${data['dog'] || 0}</td>
                            <td>${data['grandma'] || 0}</td>
                            <td>${data['plastic-bag'] || 0}</td>
                        </tr>`;
                }
                
                tableHtml += `
                        </tbody>
                    </table>`;
                
                logItem.innerHTML = `
                    <div class="log-header">
                        <span>è®­ç»ƒæ•°æ®</span>
                        <span class="log-time">${timestamp}</span>
                    </div>
                    <div class="log-content">
                        è®­ç»ƒå®Œæˆï¼Œå½“å‰è®­ç»ƒæ•°æ®é›†å¦‚ä¸‹ï¼š
                        ${tableHtml}
                    </div>`;
                
                // æ·»åŠ åˆ°æ—¥å¿—å®¹å™¨
                logsContainer.prepend(logItem);
            }
            
            // è®°å½•æµ‹è¯•ç»“æœåˆ°æ—¥å¿—
            function logTestResults(results, imageSrc) {
                const now = new Date();
                const timestamp = now.toLocaleString();
                
                // åˆ›å»ºæ—¥å¿—é¡¹
                const logItem = document.createElement('div');
                logItem.className = 'log-item';
                
                // æ„å»ºæµ‹è¯•ç»“æœè¡¨æ ¼
                let tableHtml = `
                    <table class="log-table">
                        <thead>
                            <tr>
                                <th>ç±»åˆ«</th>
                                <th>æ¦‚ç‡</th>
                            </tr>
                        </thead>
                        <tbody>`;
                
                // æ·»åŠ æ¯è¡Œæ•°æ®
                results.forEach(result => {
                    tableHtml += `
                        <tr>
                            <td>${result.name}</td>
                            <td>${result.probability}%</td>
                        </tr>`;
                });
                
                tableHtml += `
                        </tbody>
                    </table>`;
                
                logItem.innerHTML = `
                    <div class="log-header">
                        <span>æµ‹è¯•ç»“æœ</span>
                        <span class="log-time">${timestamp}</span>
                    </div>
                    <div class="log-content">
                        æµ‹è¯•å›¾ç‰‡è¯†åˆ«ç»“æœå¦‚ä¸‹ï¼š
                        ${tableHtml}
                    </div>`;
                
                // æ·»åŠ åˆ°æ—¥å¿—å®¹å™¨
                logsContainer.prepend(logItem);
            }
            
            // è®¾ç½®æ‹–æ”¾åŒºåŸŸäº‹ä»¶
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                dropArea.classList.add('drag-over');
            }
            
            function unhighlight() {
                dropArea.classList.remove('drag-over');
            }
            
            // æ·»åŠ æ‹–æ”¾å¤„ç†
            dropArea.addEventListener('drop', handleDrop, false);
            
            // æ”¯æŒç‚¹å‡»ä¸Šä¼ 
            dropArea.addEventListener('click', function() {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*';
                fileInput.onchange = function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            // ä¸ºä¸Šä¼ çš„å›¾ç‰‡éšæœºé€‰æ‹©ä¸€ä¸ªç±»å‹è¿›è¡Œæµ‹è¯•
                            const actualType = ['rock', 'barrier', 'dog', 'grandma', 'plastic-bag'][Math.floor(Math.random() * 5)];
                            const results = calculateProbabilities(actualType);
                            displayRecognitionResults(results, e.target.result);
                        };
                        reader.readAsDataURL(file);
                    }
                };
                fileInput.click();
            });
        });
    </script>
</body>
</html>